#!/usr/bin/env bash

# This script allows Hopsworks to modify the docker cgroup configuration.

help() {
    echo ""
    echo "usage: memory_hard_limit memory_soft_limit cpu_qouta"
    echo ""
    exit 1
}


if [ $# -ne 3 ]; then
        help
fi

MEMORY_HARD_LIMIT=$1
MEMORY_SOFT_LIMIT=$2
CPU_QUOTA=$3
<% if node['platform_family'] == "rhel" -%>
DOCKER_CGROUP_SERVICE=/usr/lib/systemd/system/docker-cgroup-rewrite.service
<% end -%>
<% if node['platform_family'] != "rhel" -%>
DOCKER_CGROUP_SERVICE=/lib/systemd/system/docker-cgroup-rewrite.service
<% end -%>
#set values in the docker-cgroup-rewrite.service
sudo sed -i "s/memory_limit_bytes.*\\\/memory_limit_bytes=${MEMORY_HARD_LIMIT} \\\/" $DOCKER_CGROUP_SERVICE
sudo sed -i "s/memory_soft_limit_bytes.*\\\/memory_soft_limit_bytes=${MEMORY_SOFT_LIMIT} \\\/" $DOCKER_CGROUP_SERVICE
sudo sed -i "s/cpu_quota=.*/cpu_quota=${CPU_QUOTA}/" $DOCKER_CGROUP_SERVICE

#reload and restart service
sudo systemctl daemon-reload
sudo systemctl restart docker-cgroup-rewrite
exit $?
